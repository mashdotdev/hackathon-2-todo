# Implementation Plan: Phase III AI-Powered Chatbot with MCP

**Branch**: `003-phase3-ai-chatbot` | **Date**: 2025-12-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-phase3-ai-chatbot/spec.md`

## Summary

Transform the Phase II todo application into a conversational AI interface. Users interact via natural language commands ("Add a task to buy groceries") which are processed by an OpenAI Agent connected to an **MCP Server** that exposes CRUD operations as MCP tools. The agent calls these tools via the Model Context Protocol, returning conversational responses. The chat UI uses Vercel AI SDK with streaming, and conversation history persists to PostgreSQL.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5.x (frontend)
**Primary Dependencies**:
- Backend: OpenAI Agents SDK 0.6.4, FastAPI 0.115+, SQLModel
- Frontend: Vercel AI SDK 5.x (@ai-sdk/react), Next.js 16+

**Storage**: PostgreSQL (Neon Serverless) - extend with conversations/messages tables
**Testing**: pytest + pytest-asyncio (backend), Vitest (frontend)
**Target Platform**: Web application (responsive)
**Project Type**: Web (frontend + backend monorepo)
**Performance Goals**:
- Chat response initiation: <2s
- Task operations: <5s end-to-end
- Intent recognition: 90% accuracy

**Constraints**:
- Stateless backend (conversation state in DB)
- Single conversation thread per user
- English language only

**Scale/Scope**: Same as Phase II (~50 concurrent users)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Spec-Driven Development | ✅ PASS | spec.md created via `/sp.specify`, plan via `/sp.plan` |
| II. No Manual Coding | ✅ READY | All code to be generated by Claude Code |
| III. Test-First Development | ✅ PLANNED | Tests for MCP tools before implementation |
| IV. AI-Native Architecture | ✅ PASS | OpenAI Agents SDK + MCP tools per constitution |
| VII. Security-First | ✅ PASS | User isolation via user_id, JWT auth reused |
| VIII. Observability | ✅ PLANNED | Structured logging for agent calls |
| IX. Simplicity & YAGNI | ✅ PASS | Single conversation thread, no voice/multilang |

## Project Structure

### Documentation (this feature)

```text
specs/003-phase3-ai-chatbot/
├── plan.md              # This file
├── research.md          # Technology research (OpenAI Agents, MCP, AI SDK)
├── data-model.md        # Conversation/Message entities
├── quickstart.md        # Setup guide for Phase III
├── contracts/
│   ├── chat-api.yaml    # OpenAPI spec for /api/chat
│   └── mcp-tools.md     # MCP tool contracts
└── tasks.md             # Generated by /sp.tasks (next step)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── main.py                    # FastAPI app (add chat router)
│   ├── models/
│   │   ├── user.py               # Existing
│   │   ├── task.py               # Existing
│   │   ├── conversation.py       # NEW: Conversation model
│   │   └── message.py            # NEW: Message model
│   ├── schemas/
│   │   ├── chat.py               # NEW: Chat request/response schemas
│   │   └── ...                   # Existing
│   ├── services/
│   │   ├── task_service.py       # Existing (reuse for tools)
│   │   ├── auth_service.py       # Existing
│   │   ├── chat_service.py       # NEW: Conversation persistence
│   │   └── agent_service.py      # NEW: OpenAI Agent orchestration
│   ├── mcp/
│   │   ├── __init__.py           # NEW: MCP server setup
│   │   ├── server.py             # NEW: FastMCP server with tools
│   │   └── tools/
│   │       ├── __init__.py       # NEW: Tool exports
│   │       ├── add_task.py       # NEW: @mcp.tool()
│   │       ├── list_tasks.py     # NEW: @mcp.tool()
│   │       ├── complete_task.py  # NEW: @mcp.tool()
│   │       ├── update_task.py    # NEW: @mcp.tool()
│   │       └── delete_task.py    # NEW: @mcp.tool()
│   └── api/routes/
│       ├── chat.py               # NEW: POST /api/chat, GET/DELETE history
│       └── ...                   # Existing
├── tests/
│   ├── unit/
│   │   └── test_tools.py         # NEW: Tool unit tests
│   └── integration/
│       └── test_chat.py          # NEW: Chat API integration tests
└── alembic/
    └── versions/
        └── xxx_add_chat_tables.py  # NEW: Migration

frontend/
├── src/
│   ├── app/
│   │   ├── chat/
│   │   │   └── page.tsx          # NEW: Chat interface
│   │   └── ...                   # Existing
│   ├── components/
│   │   ├── ChatMessage.tsx       # NEW: Message bubble component
│   │   ├── ChatInput.tsx         # NEW: Input with loading state
│   │   └── ...                   # Existing
│   └── lib/
│       └── api.ts                # Add chat API methods
└── tests/
    └── chat.test.tsx             # NEW: Chat component tests
```

**Structure Decision**: Web application structure (Option 2) - extending existing backend/ and frontend/ directories from Phase II.

## Complexity Tracking

> No constitution violations requiring justification. Architecture follows constitution patterns.

| Aspect | Approach | Simplicity Justification |
|--------|----------|--------------------------|
| Agent Framework | OpenAI Agents SDK | Constitution-mandated, native tool calling |
| Tool Definition | MCP SDK (FastMCP) | Constitution-mandated - "Tool exposure MUST follow MCP standards" |
| MCP Integration | HostedMCPTool or MCPServerStreamableHttp | Agent SDK has native MCP support |
| Chat UI | Vercel AI SDK useChat | Mature, less complex than ChatKit |
| Streaming | SSE via Data Stream Protocol | Standard pattern, works with useChat |

## Phase 0 Outputs

### research.md (Complete)
- Decision: OpenAI Agents SDK v0.6.4 for agent logic
- Decision: **MCP SDK (FastMCP)** for tool implementation (hackathon requirement)
- Decision: Vercel AI SDK (useChat) for frontend chat
- Decision: SSE Data Stream Protocol for streaming
- Decision: Streamable HTTP transport for MCP server

## Phase 1 Outputs

### data-model.md (Complete)
- Conversation entity (1:1 with User)
- Message entity (belongs to Conversation)
- Migration script for new tables

### contracts/ (Complete)
- `chat-api.yaml`: OpenAPI spec for chat endpoints
- `mcp-tools.md`: Tool contracts (add_task, list_tasks, complete_task, update_task, delete_task)

### quickstart.md (Complete)
- Step-by-step setup instructions
- Dependency installation
- Basic chat page scaffold

## Key Implementation Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Agent Framework | OpenAI Agents SDK | Constitution requirement (Principle IV) |
| UI Framework | Vercel AI SDK | More mature than ChatKit, better docs |
| Tool Implementation | **MCP SDK (FastMCP)** | Constitution requirement - "Tool exposure MUST follow MCP standards" |
| MCP Transport | Streamable HTTP | Best for web deployments, bidirectional |
| Streaming Protocol | SSE + Data Stream | Compatible with useChat hook |
| Conversation Model | Single thread per user | Per spec (out of scope: multiple threads) |
| Task Matching | Fuzzy by title | Better UX than requiring IDs |

## Security Measures

1. **User Isolation**: All tools require user_id, extracted from JWT
2. **Input Validation**: Message length limits (1000 chars), guardrails
3. **Token Handling**: Reuse Phase II JWT auth
4. **No Secrets Exposed**: OpenAI key on backend only

## Next Steps

Run `/sp.tasks` to generate actionable implementation tasks from this plan.

---

**Artifacts Created**:
- `specs/003-phase3-ai-chatbot/research.md`
- `specs/003-phase3-ai-chatbot/data-model.md`
- `specs/003-phase3-ai-chatbot/quickstart.md`
- `specs/003-phase3-ai-chatbot/contracts/chat-api.yaml`
- `specs/003-phase3-ai-chatbot/contracts/mcp-tools.md`
